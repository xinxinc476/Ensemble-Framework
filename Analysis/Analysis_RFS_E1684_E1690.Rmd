---
title: "Analysis of Replase-Free Survival (RFS) Time for (E1684, E1690) Data Sets"
output: 
  html_notebook:
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(survival)
library(hdbayes)
library(posterior)
library(ggplot2)
library(latex2exp)
library(collapse)
library(loo)
library(kableExtra)

wrapper.dir <- "~/Documents/UNC/Dissertation/super prior/Code/R/wrapper_sim"
source(file.path(wrapper.dir, "get_trt_effect.R"))
```


# Summary of Baseline Covariate


```{r}
## load data
hist <- E1684
curr <- E1690

## replace 0 failure times with 0.50 days
hist <- hist %>% mutate(failtime = if_else(failtime == 0, 0.50/365.25, failtime)) # 1 subject w/ failtime = 0
curr <- curr %>% mutate(failtime = if_else(failtime == 0, 0.50/365.25, failtime)) # 10 subjects w/ failtime = 0

#no subjects in current data w/ survtime = 0 

## Center and scale age based on current data
age_stats <- with(curr, c('mean' = mean(age), 'sd' = sd(age)))
hist$cage <- ( hist$age - age_stats['mean'] ) / age_stats['sd']
curr$cage <- ( curr$age - age_stats['mean'] ) / age_stats['sd']
```

```{r}
library(gtsummary)

## create summary table
df       <- rbind(curr, hist) %>%
  mutate(
    Treatment = case_when(
      treatment == 1 ~ "Treatment",
      TRUE ~ "Control"
    ),
    Sex = factor(sex, levels = c(0, 1), labels = c("Male", "Female")),
    `Having > 1 cancerous lymph node` = case_when(
      `node_bin` == 1 ~ "Yes (> 1 node)",
      TRUE ~ "No (0 or 1 node)"
    ),
    Age = age,
    `Standardized Age` = cage
  )
df$Study <- rep(c("E1690", "E1684"), times = c(nrow(curr), nrow(hist)))

tab <- df %>%
  select(all_of(c("Treatment", "Sex", "Age", "Standardized Age", "Having > 1 cancerous lymph node", "Study"))) %>%
  tbl_summary(
    by = Study,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 2
  ) %>%
  modify_header(label ~ "**Variable**",
                `stat_1` ~ "E1684, N = 262",
                `stat_2` ~ "E1690, N = 426")
tab
# show_header_names(tab)
```



# Frequentist Analysis

```{r}
## formula for current and historical data (Cox PH model)
fmla     <- Surv(failtime, failcens) ~ treatment + sex + cage + node_bin

## fit proportional hazards models on E1690 and E1684 data
fit      <- coxph(formula = fmla, data = curr)
fit.hist <- coxph(formula = fmla, data = hist)

summary(fit)
summary(fit.hist)
```


```{r}
## combine Cox PH model estimates with summary of baseline covariates 
tab.E1690.coxph <- coxph(
  Surv(failtime, failcens) ~ Treatment + Sex + `Standardized Age` + `Having > 1 cancerous lymph node`,
  data = df[df$Study == "E1690", ]
) %>%
  tbl_regression(
    label = list(
      `Sex` ~ "Sex",
      `Standardized Age` ~ "Standardized Age",
      `Having > 1 cancerous lymph node` ~ "Having > 1 cancerous lymph node"
    ),
    exponentiate = TRUE
  ) %>%
  modify_header(label ~ "**Variable**")  %>%
  modify_column_hide(columns = p.value)

tab.E1684.coxph <- coxph(
  Surv(failtime, failcens) ~ Treatment + Sex + `Standardized Age` + `Having > 1 cancerous lymph node`,
  data = df[df$Study == "E1684", ]
) %>%
  tbl_regression(
    label = list(
      `Sex` ~ "Sex",
      `Standardized Age` ~ "Standardized Age",
      `Having > 1 cancerous lymph node` ~ "Having > 1 cancerous lymph node"
    ),
    exponentiate = TRUE
  ) %>%
  modify_header(label ~ "**Variable**") %>%
  modify_column_hide(columns = p.value)

library(gt)
tab.combined <- tbl_merge(
  tbls = list(tab, tab.E1684.coxph, tab.E1690.coxph),
  tab_spanner = c("**Summary Statistics**", "**Cox PH Model for E1684**", "**Cox PH Model for E1690**")
) %>%
  as_gt() %>%
  #gt::tab_source_note("Cox PH Model: Cox proportional hazards (PH) regression model including Treatment, Sex, Standardized Age, and Having > 1 cancerous lymph node.")
  gt::tab_footnote(
    footnote = "Cox proportional hazards (PH) regression model including Treatment, Sex, Standardized Age, and Having > 1 cancerous lymph node.",
    locations = cells_column_spanners(c("**Cox PH Model for E1684**", "**Cox PH Model for E1690**"))
  )

#tab.combined %>%
#  gtsave(filename = "tab1_summary_stats.png", path = "/Users/xinxin/Documents/UNC/Dissertation/super prior/Code/Figures")
tab.combined
```


# Bayesian Analysis 

We fit a proportional hazards (PH) model with a piece-wise constant baseline hazards using the equivalent Poisson likelihood. We assumed 5 intervals for the piece-wise constant baseline hazards. The cut points of these intervals were selected such that each interval consists of about the same number of events/relapses.

We consider the following list of priors for analysis: the reference prior, Bayesian hierarchical model (BHM), commensurate prior, power prior, normalized power prior (NPP), latent exchangeability prior (LEAP), and propensity score-integrated power prior (PSIPP). For historical data priors, information are borrowed on both the treatment and control arms.

The goal is to compare the 2-year survival probabilities between the treatment and control arm.

```{r}
results.dir <- "~/Documents/UNC/Dissertation/super prior/Code/Analysis/Results"
file.list   <- list.files(results.dir, pattern = 'nintervals_5.rds')
file.list   <- file.list[-c(3,6,7)] ## rm pp w/ a0 = 0.2 and 0.8 as well as psipp for now

## obtain cut points for intervals
nbreaks <- 5
probs   <- 1:nbreaks / nbreaks
breaks  <- curr %>%
  filter(failcens == 1) %>%
  reframe(quant = quantile(failtime, probs = probs)) %>%
  unlist
breaks  <- breaks[-nbreaks]
```


## Predicted Difference in 2-Year Survival Probabilities from Individual Priors

```{r, eval=FALSE}
surv.diff.list <- list(length = length(file.list))
loo.list       <- list(length = length(file.list))
logml.list     <- list(length = length(file.list))

time.list     <- seq(0, 7, length = 100)
surv.prob.trt <- list(length = length(file.list))
surv.prob.ctl <- list(length = length(file.list))

for (i in 1:length(file.list)) {
  res.i         <- readRDS(file.path(results.dir, file.list[i]))
  loo.list[[i]] <- res.i$res.loo
  logml.list[[i]] <- res.i$res.logml
  
  d     <- res.i$draws
  prior <- res.i$scen$priors
  
  if ( prior == "psipp" ){
    d.surv.diff <- get.surv.diff.2yr.psipp(
      post.samples = d,
      breaks = breaks
    )
    surv.prob <- sapply(time.list, function(x){
      res.surv <- get.surv.prob.psipp(
        t = x,
        post.samples = d,
        breaks = breaks
      )
      return(
        c("trt" = mean(res.surv$surv.trt),
          "ctl" = mean(res.surv$surv.ctl))
      )
    })
    
  }else{
    d.surv.diff <- get.surv.diff.2yr.glm(
       post.samples = d,
       data = curr,
       breaks = breaks
    )
    surv.prob <- sapply(time.list, function(x){
      res.surv <- get.surv.prob.glm(
        t = x,
        post.samples = d,
        data = curr,
        breaks = breaks
      )
      return(
        c("trt" = mean(res.surv$surv.trt),
          "ctl" = mean(res.surv$surv.ctl))
      )
    })
  
  }
  
  surv.diff.list[[i]] <- d.surv.diff
  surv.prob.trt[[i]]  <- surv.prob["trt", ]
  surv.prob.ctl[[i]]  <- surv.prob["ctl", ]
  
  estim.i <- round(c(mean = mean(d.surv.diff), sd = sd(d.surv.diff), 
                     quantile2(d.surv.diff, probs = c(0.5, 0.025, 0.975))), 3)
  prior.i <- prior
  
  if( i == 1 ){
    estim  <- estim.i
    priors <- prior.i
  }else{
    estim  <- rbind(estim, estim.i)
    priors <- c(priors, prior.i)
  }
  print( paste0("######################## Completed iteration ", i, "######################## "))
  
  temp <- list(
    loo.list = loo.list,
    surv.diff.list = surv.diff.list,
    surv.prob.ctl = surv.prob.ctl,
    surv.prob.trt = surv.prob.trt,
    logml.list = logml.list,
    estim = estim,
    priors = priors
  )
  saveRDS(temp, 
          "~/Documents/UNC/Dissertation/super prior/Code/Analysis/compiled_analysis_results.rds")
}
rm(temp)
```


```{r}
res <- readRDS(file = "~/Documents/UNC/Dissertation/super prior/Code/Analysis/compiled_analysis_results.rds")
loo.list <- res$loo.list
surv.diff.list <- res$surv.diff.list
surv.prob.ctl  <- res$surv.prob.ctl
surv.prob.trt  <- res$surv.prob.trt
logml.list     <- res$logml.list
estim  <- res$estim
priors <- res$priors

estim <- as.data.frame(estim)
estim <- cbind(prior = priors, estim) %>%
  as.data.frame()
rownames(estim) <- NULL
estim
```

For NPP, the posterior mean of $a_0$ is about 0.5781.

```{r}
res.npp <- readRDS(file.path(results.dir, "PWE_id_116_npp_nintervals_5.rds"))
res.npp$draws %>% 
  summarize_draws(mean, sd, ~quantile2(.x, probs = c(0.025, 0.975))) %>%
  filter(variable == "a0_hist_1")
```

For LEAP, the posterior mean of the probability of subjects in historical data being exchangeable with those in current data is about 0.857.

```{r}
res.leap <- readRDS(file.path(results.dir, "PWE_id_102_leap_nintervals_5.rds"))
res.leap$draws %>% 
  summarize_draws(mean, sd, ~quantile2(.x, probs = c(0.025, 0.975))) %>%
  filter(variable == "gamma")
```


## Weights from model-averaging priors

```{r}
## BMA weights
logml.vals <- lapply(logml.list, function(l){
  l$logml
})
logml.vals <- unlist(logml.vals)
post.prob <- bridgesampling::post_prob(logml.vals)


lpd_point  <- sapply(loo.list, function(l){
    l$pointwise[,"elpd_loo"]
})

pbma_wts     <- pseudobma_weights(lpd_point, BB=FALSE)
pbma_BB_wts  <- pseudobma_weights(lpd_point) # default is BB=TRUE
stacking_wts <- stacking_weights(lpd_point)

wts.tab <- data.frame(
  prior = estim$prior,
  "BMA" = round(post.prob, 3),
  "Pseudo-BMA" = round(pbma_wts, 3),
  "Pseudo-BMA w/ BB" = round(pbma_BB_wts, 3),
  "Stacking" = round(stacking_wts, 3)
)
rownames(wts.tab) <- NULL
colnames(wts.tab)[3:4] <- c("Pseudo-BMA", "Pseudo-BMA w/ BB")
wts.tab
```


## Predicted Difference in 2-Year Survival Probabilities from All Methods

```{r}
d.surv.diff.mtx      <- do.call(cbind, surv.diff.list)

d.surv.diff.bma      <- sample.model.avg.prior(wts = post.prob, samples.mtx = d.surv.diff.mtx)
d.surv.diff.pbma     <- sample.model.avg.prior(wts = pbma_wts, samples.mtx = d.surv.diff.mtx)
d.surv.diff.pbma.BB  <- sample.model.avg.prior(wts = pbma_BB_wts, samples.mtx = d.surv.diff.mtx)
d.surv.diff.stacking <- sample.model.avg.prior(wts = stacking_wts, samples.mtx = d.surv.diff.mtx)


estim2 <- lapply(list(d.surv.diff.bma, d.surv.diff.pbma, d.surv.diff.pbma.BB, d.surv.diff.stacking), function(l){
  round(c(mean = mean(l), sd = sd(l), quantile2(l, probs = c(0.5, 0.025, 0.975))), 3)
})
estim2 <- do.call(rbind, estim2) %>%
  as.data.frame()
estim2 <- cbind(
  prior = c("BMA", "Pseudo-BMA", "Pseudo-BMA w/ BB", "Stacking"),
  estim2
) %>% as.data.frame()

estim_all
```

```{r}
estim_all[!estim_all$prior %in% c("Pseudo-BMA", "Pseudo-BMA w/ BB"), ]
```


```{r}
# create tables
wts.tab$prior <- recode(
  wts.tab$prior, leap = "LEAP", npp = "NPP", `pp_0.5` = "PP", ref = "Reference",
  bhm = "BHM", commensurate = "Commensurate"
)
rownames(wts.tab) <- wts.tab$prior
tab_wts <- wts.tab[c("Reference", "BHM", "Commensurate", "LEAP", "NPP", "PP"), c("prior", "BMA", "Stacking")]
rownames(tab_wts) <- NULL


estim_all <- rbind(estim, estim2) %>% as.data.frame()
estim_all$prior <- recode(
  estim_all$prior, leap = "LEAP", npp = "NPP", `pp_0.5` = "PP", ref = "Reference",
  bhm = "BHM", commensurate = "Commensurate"
)
rownames(estim_all) <- estim_all$prior
estim_tab <- estim_all[c("Reference", "BHM", "Commensurate", "LEAP", "NPP", "PP", "BMA", "Stacking"), c("prior", "mean", "q2.5", "q97.5")]
rownames(estim_tab) <- NULL

# construct credible interval as string
textci <- function(lower, upper, digits = 3, mathmode = TRUE) {
  lower.ch <- formatC(lower, digits = digits, format = 'f')
  lower.ch[lower > 0] <- paste0('~', lower.ch[lower > 0])
  upper.ch <- formatC(upper, digits = digits, format = 'f')
  upper.ch[upper > 0] <- paste0('~', upper.ch[upper > 0])
  ci <- paste0('(', lower.ch, ', ', upper.ch, ')')
  if (mathmode)
    ci <- paste0('$', ci, '$')
  ci
}

ndigits <- 3
estim_tab <- estim_tab %>%
  mutate(CI = textci(`q2.5`, `q97.5`, digits = ndigits))

estim_tab$weights_BMA <- c(formatC(tab_wts$BMA, digits = ndigits, format = 'f'), '----', '----')
estim_tab$weights_stacking <- c(formatC(tab_wts$Stacking, digits = ndigits, format = 'f'), '----', '----')

estim_tab$prior[which(estim_tab$prior == "BMA")] <- "Ensemble (BMA Weights)"
estim_tab$prior[which(estim_tab$prior == "Stacking")] <- "Ensemble (Stacking Weights)"

tab <- estim_tab %>%
  dplyr::select(prior, mean, CI, weights_BMA, weights_stacking) %>%
  kable("latex",
      col.names = c('Method', 'Mean', '$95\\%$ CI', 'BMA Weight', 'Stacking Weight'),
      digits = ndigits, align = 'c',
      booktabs=TRUE, escape = FALSE,
      caption = 'Posterior Estimates of $\\Delta$ with Model Weights from BMA and Stacking')
```


## Posterior Density Plot of Predicted Difference in 2-Year Survival Probabilities

1. Posterior densities from PP with $a_0 = 0.5$, NPP, and BMA are quite similar to each other.

```{r}
surv_diff_df           <- cbind(d.surv.diff.mtx, d.surv.diff.bma, d.surv.diff.pbma, d.surv.diff.pbma.BB, d.surv.diff.stacking)
colnames(surv_diff_df) <- c(estim$prior, "Ensemble (BMA Weights)", "Ensemble (Pseudo-BMA Weights)", "Ensemble (Pseudo-BMA + BB Weights)", "Ensemble (Stacking Weights)")
colnames(surv_diff_df) <- recode(colnames(surv_diff_df),
                                 ref = "Reference",
                                 leap = "LEAP",
                                 npp = "NPP",
                                 `pp_0.5` = "PP",
                                 bhm = "BHM",
                                 commensurate = "Commensurate")

surv_diff_df           <- as.data.frame(surv_diff_df)
surv_diff_df_long      <- surv_diff_df %>%
  pivot_longer(
    cols = all_of(colnames(surv_diff_df)),
    names_to = "method",
    values_to = "estimate"
  )
surv_diff_df_long$method <- factor(surv_diff_df_long$method,
                                  levels = c("Reference", "BHM", "Commensurate", "LEAP", "NPP",
                                             "PP", "Ensemble (BMA Weights)", 
                                             "Ensemble (Pseudo-BMA Weights)",
                                             "Ensemble (Pseudo-BMA + BB Weights)", 
                                             "Ensemble (Stacking Weights)"),
                                  ordered = T)
```

```{r}
cbPalette <- c("#999999", "#CC79A7", "#F0E442", "#E69F00", "#0072B2", "#009E73", "#56B4E9", "#D55E00")

surv_diff_df_long %>%
  filter(! method %in% c("Ensemble (Pseudo-BMA Weights)", "Ensemble (Pseudo-BMA + BB Weights)")) %>%
  ggplot(aes(x=estimate, color = method)) +
  geom_density() +
  scale_colour_manual(values= cbPalette) +
  labs(title = "Posterior Density of Estimated Difference in Two-Year RFS Probabilities",
       color = "Method")

surv_diff_df_long %>%
  filter( method %in% c("Ensemble (BMA Weights)", "Ensemble (Pseudo-BMA Weights)", "Ensemble (Pseudo-BMA + BB Weights)", "Ensemble (Stacking Weights)")) %>%
  ggplot(aes(x=estimate, color = method)) +
  geom_density() +
  scale_colour_manual(values=  c("#999999", "#CC79A7", "#0072B2", "#E69F00")) +
  labs(title = "Posterior Density of Estimated Difference in Two-Year RFS Probabilities",
       color = "Method") +
  theme_bw()
```


```{r}
cbPalette <- c("#999999", "#CC79A7", "#009E73", "#E69F00","#56B4E9", "#D55E00")

surv_diff_df_long %>%
  filter(! method %in% c("Ensemble (Pseudo-BMA Weights)", "Ensemble (Pseudo-BMA + BB Weights)"
                         , "NPP", "PP")) %>%
  ggplot(aes(x=estimate, color = method)) +
  geom_density() +
  scale_colour_manual(values= cbPalette) +
  labs(title = "Posterior Density of Estimated Difference in Two-Year RFS Probabilities",
       color = "Method") +
  theme_bw() +
      theme(legend.position = "bottom",
            legend.box = "vertical",
            legend.text=element_text(size=10),
            legend.key.width= unit(2, 'cm'), 
            legend.margin=margin(),
            strip.text.x = element_text(size = 10),
            strip.text.y = element_text(size = 10),
            plot.title = element_text(hjust = 0.5, size = 14))
#width:690, height:450
```



### Posterior Density Plot for PSIPP per Stratum

```{r}
#' function to predict survival probability at t years for treated and untreated groups for each stratum under PSIPP
#' 
get.surv.prob.psipp.stratum <- function(
    t, 
    post.samples,
    breaks
){
  J          = length(breaks) + 1
  stan.data  = attr(post.samples, 'data')
  p          = stan.data$p
  K          = stan.data$K
  X          = stan.data$X
  beta       = suppressWarnings(
    as.matrix( post.samples[, paste0( "treatment", '_stratum_', 1:K ), drop=F] )
  )
  
  log_hazard = suppressWarnings(
    as.matrix( post.samples[, paste0( colnames(X)[-which(colnames(X) == "treatment")], '_stratum_', rep(1:K, each = p-1) ), drop=F] )
  )
  interval_names = colnames(X)[-which(colnames(X) == "treatment")]
  
  ## interval index for which the time t belongs to
  interval.id = findInterval(t, c(0, breaks, Inf), left.open = TRUE)
  if( t == 0 ){
    interval.id = 1
  }
  
  breaks.new              = (c(breaks, Inf))[1:interval.id]
  breaks.new[interval.id] = t
  interval.length         = breaks.new - c(0, breaks.new[-interval.id])
  
  ## compute cumulative baseline hazard at t years for each stratum
  H = sapply(1:K, function(k){
    log_hazard_stratum = log_hazard[, paste0(interval_names, '_stratum_', k)]
    log_hazard_stratum = log_hazard_stratum[, 1] + cbind(0, log_hazard_stratum[, 2:J])
    hazard_stratum     = exp(log_hazard_stratum) ## baseline hazards
    
    H_stratum          = hazard_stratum[, 1:interval.id, drop = F] %r*% interval.length 
    if( interval.id != 1 ){
      H_stratum        = t( apply(H_stratum, 1, cumsum) ) ## cumulative baseline hazard
    }
    H_stratum        = H_stratum[, interval.id]
    return( H_stratum)
  })
  
  ## predicted t-year survival probability for untreated for each stratum
  S.ctl = lapply(1:K, function(k){
    H_stratum     = H[, k]
    S_ctl_stratum = exp( -H_stratum )
    return(S_ctl_stratum)
  }
  )
  S.ctl = do.call(cbind, S.ctl)

  ## predicted t-year survival probability for untreated for each stratum
  S.trt = lapply(1:K, function(k){
    H_stratum     = H[, k]
    beta_stratum  = beta[, paste0( 'treatment_stratum_', k)]
    S_trt_stratum = exp( -H_stratum * exp(beta_stratum) )
    return(S_trt_stratum)
  }
  )
  S.trt = do.call(cbind, S.trt)
  
  return(
    list(
      surv.trt.stratum = S.trt,
      surv.ctl.stratum = S.ctl
    )
  )
}

#' function to estimate the treatment effect (difference in 2-year survival probability between treated and untreated) for each stratum,
#' i.e., P(T > 2 | A = 1) - P(T > 2 | A = 0), for PSIPP
get.surv.diff.2yr.psipp.stratum <- function(
    post.samples,
    breaks
) {
  surv.list = get.surv.prob.psipp.stratum(
    t = 2,
    post.samples = post.samples,
    breaks = breaks
  )
  surv.diff  = surv.list$surv.trt.stratum - surv.list$surv.ctl.stratum
  return(surv.diff)
}
```


```{r}
res.psipp <- readRDS(file.path(results.dir, "PWE_id_60_psipp_nintervals_5.rds"))

d.surv.diff.psipp.stratum <- get.surv.diff.2yr.psipp.stratum(
  post.samples = res.psipp$draws,
  breaks = breaks
)
colnames(d.surv.diff.psipp.stratum) <- paste0("Stratum ", 1:ncol(d.surv.diff.psipp.stratum))

surv_diff_df_psipp      <- as.data.frame(d.surv.diff.psipp.stratum)
surv_diff_df_psipp_long <- surv_diff_df_psipp %>%
  pivot_longer(
    cols = all_of(colnames(surv_diff_df_psipp)),
    names_to = "strata",
    values_to = "estimate"
  )
surv_diff_df_psipp_long$strata <- factor(surv_diff_df_psipp_long$strata,
                                         levels = paste0("Stratum ", 1:ncol(d.surv.diff.psipp.stratum)),
                                         ordered = T)

ggplot(surv_diff_df_psipp_long, aes(x=estimate, col = strata, linetype = strata)) +
  geom_density() +
  scale_colour_manual(values= c("#999999", "#56B4E9", "#CC79A7", "orange")) +
  labs(title = "Posterior Density of Predicted Difference in 2-Year Survival Probabilities",
       subtitle = "for Each Stratum under PSIPP")
```


## Predicted Survival Probabilities

```{r}
surv.prob.ctl.long <- lapply(1:length(priors), function(i){
  df = cbind(prob = surv.prob.ctl[[i]], trt = 0, time = time.list) %>% as.data.frame()
  df$priors = priors[[i]]
  return(df)
})
surv.prob.ctl.long <- do.call(rbind, surv.prob.ctl.long)

surv.prob.trt.long <- lapply(1:length(priors), function(i){
  df = cbind(prob = surv.prob.trt[[i]], trt = 1, time = time.list) %>% as.data.frame()
  df$priors = priors[[i]]
  return(df)
})
surv.prob.trt.long <- do.call(rbind, surv.prob.trt.long)

surv.prob     <- rbind(surv.prob.ctl.long, surv.prob.trt.long) %>% as.data.frame()
surv.prob$trt <- as.factor(surv.prob$trt)

surv.prob %>%
  ggplot(aes(x = time, y = prob, color = trt)) +
  geom_line() +
  #geom_point() +
  labs(x = 'time') +
  facet_wrap(~priors) +
  labs(title = "Predicted Survival Probabilities") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```


### Predicted Survival Probabilities for PSIPP per Stratum

```{r}
surv.prob.stratum <- lapply(time.list, function(x){
  res.surv = get.surv.prob.psipp.stratum(
    t = x,
    post.samples = res.psipp$draws,
    breaks = breaks
  )
  df = rbind(colMeans(res.surv$surv.trt.stratum),
              colMeans(res.surv$surv.ctl.stratum)) %>%
    as.data.frame()
  colnames(df) = paste0("Stratum ", 1:ncol(df))
  df$trt  = c(1, 0)
  df$time = x
  return(df)
})
surv.prob.stratum      <- do.call(rbind, surv.prob.stratum)
surv.prob.stratum.long <- surv.prob.stratum %>%
  pivot_longer(
    cols = all_of(paste0("Stratum ", 1:(ncol(surv.prob.stratum)-2))),
    names_to = "strata",
    values_to = "prob"
  )
surv.prob.stratum.long$trt <- as.factor(surv.prob.stratum.long$trt)

surv.prob.stratum.long %>%
  ggplot(aes(x = time, y = prob, linetype = trt)) +
  geom_line() +
  #geom_point() +
  labs(x = 'time') +
  facet_wrap(~strata) +
  labs(title = "Predicted Survival Probabilities for Each Stratum under PSIPP", linetype = "Treatment") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
res.strata <- res.psipp$res.strata
res.strata.curr <- cbind(res.strata$data.list$curr, stratum = res.strata$strata.list$curr)

res.strata.curr %>%
  group_by(stratum) %>%
  summarise(mean_sex = mean(sex), mean_age = mean(age), mean_node_bin = mean(node_bin))
```

